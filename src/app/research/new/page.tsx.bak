"use client";

import { useRouter } from "next/navigation";
import { useCallback, useEffect, useState } from "react";
import { AppShell } from "@/app/(components)/app-shell";
import { ResearchInput } from "@/app/(components)/research-input";
import { ThreadList } from "@/app/(components)/thread-list";
import type { ThreadMetadata } from "@/types/ui";

/**
 * New Research Page
 *
 * Entry point for starting new research sessions.
 * ChatGPT-style layout with input at bottom.
 *
 * Layout:
 * - Left: Thread history
 * - Center: Empty space for future messages, input at bottom
 * - Right: Hidden (no sources until research starts)
 */
export default function NewResearchPage() {
  const router = useRouter();
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [threads, setThreads] = useState<ThreadMetadata[]>([]);

  /**
   * Load threads from localStorage
   */
  useEffect(() => {
    const storedThreads = localStorage.getItem("research-threads");
    if (storedThreads) {
      try {
        const parsed = JSON.parse(storedThreads) as ThreadMetadata[];
        setThreads(parsed);
      } catch {
        // Ignore parse errors
      }
    }
  }, []);

  /**
   * Handle thread deletion
   */
  const handleDeleteThread = useCallback((threadId: string) => {
    setThreads((prev) => prev.filter((t) => t.threadId !== threadId));
  }, []);

  /**
   * Handle research submission
   */
  const handleSubmit = async (goal: string, mode: "auto" | "plan") => {
    setIsSubmitting(true);
    setError(null);

    try {
      const response = await fetch("/api/threads/start", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          goal,
          modeOverride: mode,
        }),
      });

      if (!response.ok) {
        const errorText = await response.text();
        throw new Error(`Failed to start research: ${errorText}`);
      }

      const data = (await response.json()) as { threadId: string };

      // Navigate to thread view
      router.push(`/research/${data.threadId}`);
    } catch (err) {
      const errorMessage =
        err instanceof Error ? err.message : "Unknown error occurred";
      setError(errorMessage);
    } finally {
      setIsSubmitting(false);
    }
  };

  return (
    <AppShell
      centerPanel={
        <div className="flex h-full flex-col">
          {/* Empty space - messages will appear here */}
          <div className="flex-1" />

          {/* Error Display */}
          {error && (
            <div className="mx-auto mb-4 w-full max-w-3xl px-4">
              <div className="rounded-lg border border-destructive bg-destructive/10 p-3">
                <p className="text-destructive text-sm">{error}</p>
              </div>
            </div>
          )}

          {/* Research Input at bottom */}
          <div className="border-t bg-background p-4">
            <div className="mx-auto w-full max-w-3xl">
              <ResearchInput
                isSubmitting={isSubmitting}
                onSubmit={handleSubmit}
              />
            </div>
          </div>
        </div>
      }
      leftPanel={
        <ThreadList
          activeThreadId={null}
          onDeleteThread={handleDeleteThread}
          threads={threads}
        />
      }
      // No right panel - sources appear only after research starts
    />
  );
}
